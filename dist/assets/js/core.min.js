var app=function(){"use strict";var n={getParam:function(n,t){t||(t=location.href),n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var o=new RegExp("[\\?&]"+n+"=([^&#]*)").exec(t);return null==o?null:o[1]},log:function(n){config.debug&&console.log("App log:",n)},error:function(n){config.debug&&console.error("App error:",n)},encryption:function(n){var t=encodeURIComponent(n),o=encodeURIComponent(config.passphrase);return CryptoJS.AES.encrypt(t,o).toString()},decryption:function(n){var t=encodeURIComponent(config.passphrase),o=CryptoJS.AES.decrypt(n,t).toString(CryptoJS.enc.Utf8);return o=decodeURIComponent(o)},setSwitchBtnState:function(n,t){if(!(n.length<=0))return t===config.const.on?n.prop("checked",!0):n.prop("checked",!1)},getSwitchBtnState:function(n){return n.is(":checked")?config.const.on:config.const.off},grayPanel:function(n,t){t?(n.find(".grayPanel").removeClass("hidden"),n.find(".grayPanel .alert").html("Thiết bị đang tắt, hãy bật thiết bị để thiết lập cài đặt.")):n.find(".grayPanel").addClass("hidden")},changeLightIconStatus:function(n,t){return t===config.const.on?n.find("img").attr("src","assets/svg/lamp-on.svg"):n.find("img").attr("src","assets/svg/lamp-off.svg")},makeRandomString:function(n){null==n&&(n=5);for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o="",e=0;e<n;e++)o+=t.charAt(Math.floor(Math.random()*t.length));return o},makeRandomNumber:function(n){null==n&&(n=5);for(var t="0123456789",o="",e=0;e<n;e++)o+=t.charAt(Math.floor(Math.random()*t.length));return o},loginModal:function(n){n?$("login-modal").modal("show"):$("login-modal").modal("hide")},loadReady:function(){$(".container-fluid, app-bg").css({display:"block"}),$("loading-modal").css({display:"none"})},loadding:function(n,t){var o=$("loading-modal");o.find("span.text").text("Loadding.."),n?(o.modal("show"),null!==t&&o.find("span.text").text(t)):o.modal("hide")},bubbleGroup:function(){for(var n=$(".bubble-group"),t=0;t<=30;t++){var o=Math.floor(214*Math.random())+1,e=Math.floor(1328*Math.random())+1;n.find("svg g").append('<ellipse cx="'+o+'" cy="'+e+'" opacity=".19999999" rx="8" ry="8"></ellipse>')}},navDatetime:function(){var t=new Date,o=t.getHours(),e=t.getMinutes(),a=t.getSeconds();$(".navDatetime>.time").html(o+":"+c(e)+":"+c(a));var r=t.getDate(),i=t.getMonth(),l=t.getFullYear();$(".navDatetime>.day").html(l+"/"+c(i)+"/"+c(r));setTimeout(n.navDatetime,500);function c(n){return n<10&&(n="0"+n),n}},modalToCenter:function(){var n=$(this),t=n.find(".modal-dialog");n.css("display","block"),t.css("margin-top",Math.max(0,($(window).height()-t.height())/2))},confirm:function(n,t,o){var e={title:t,text:n,type:o,showCancelButton:!0,confirmButtonText:"Có",cancelButtonText:"Không"};return null==t&&(e.title="Yêu cầu xác nhận!"),swal(e)},alert:function(n,t,o){var e={title:t,html:n,type:o};return null==t&&(e.title="Thông báo !"),swal(e)}};return n}();
!function(){"use strict";$(document).ready(function(){app.loadReady(!0),feather.replace(),app.navDatetime(),"standalone"in window.navigator&&!0===window.navigator.standalone&&($("body").addClass("iosShowStatusBar").prepend('<div class="iosStatusBar"></div>'),$(document).on("click","a",function(o){if(o.preventDefault(),"modal"!==$(this).data("toggle")){var t=$(this).attr("href");"javascript:;"==t||(window.location.href=t)}})),$('[data-toggle="ctooltip"]').tooltip({template:'<div class="tooltip custom" role="tooltip"><div class="arrow"></div><div class="tooltip-inner"></div></div>',placement:"bottom"}),$("loading-modal, login-modal, aircon-modal").modal({keyboard:!1,backdrop:"static",show:!1}),PullToRefresh.init({distReload:60,classPrefix:"app-top-",iconArrow:"&#8675;",iconRefreshing:"&hellip;",instructionsPullToRefresh:"Pull down to refresh",instructionsReleaseToRefresh:"Release to refresh",instructionsRefreshing:"Refreshing..",refreshTimeout:1e3,getStyles:function(){return".__PREFIX__ptr{box-shadow: inset 0 -3px 5px rgba(0, 0, 0, 0.12); pointer-events: none; font-size: 0.85em; font-weight: bold; top: 0; height: 0; transition: height 0.3s, min-height 0.3s; text-align: center; width: 100%; overflow: hidden; display: flex; align-items: flex-end; align-content: stretch;}.__PREFIX__box{padding: 0px; flex-basis: 100%;}.__PREFIX__pull{transition: none;}.__PREFIX__text{color: rgba(0, 0, 0, 0.3);}.__PREFIX__icon{color: rgba(0, 0, 0, 0.3); transition: transform .3s;}.__PREFIX__top{touch-action: pan-x pan-down pinch-zoom;}.__PREFIX__release .__PREFIX__icon{transform: rotate(180deg);}"},onRefresh:function(){window.location.reload()},onPreRefresh:function(){$(".modal").modal("hide"),res.loadding(!0)}})})}();
var sensorChart=function(){"use strict";var t={};return $(document).ready(function(){if($("#topWidgetChart").length>0){var a=document.getElementById("topWidgetChart").getContext("2d"),e=a.createLinearGradient(500,45,100,0);e.addColorStop(0,"rgba(255, 255, 255, 1)"),e.addColorStop(1,"rgba(255, 255, 255, 1)");var o=a.createLinearGradient(500,45,100,0);o.addColorStop(0,"rgba(255, 135, 101, 1)"),o.addColorStop(1,"rgba(254, 96, 161, 1)");var l={responsive:!0,maintainAspectRatio:!1,layout:{padding:{left:0,right:0,top:0,bottom:0}},legend:{display:!1,position:"bottom"},tooltips:{yPadding:3,xPadding:4,titleSpacing:5,titleMarginBottom:0,titleFontSize:9,titleFontStyle:"normal",titleFontColor:"#fff",backgroundColor:"rgba(0,0,0,0.5)",caretSize:3,callbacks:{title:function(t,a){return a.datasets[0].data[t[0].index]+a.datasets[0].label},label:function(t,a){return null}}},hover:{mode:"label"},scales:{xAxes:[{display:!1,suggestedMin:0,beginAtZero:!0,ticks:{fontSize:10,stepSize:5,padding:5,maxRotation:0,callback:function(t,a,e){return" "}},gridLines:{display:!1,color:"#f3f3f3",drawTicks:!1},scaleLabel:{display:!1,labelString:"Month"}}],yAxes:[{display:!1,ticks:{max:26}}]},title:{display:!1,text:"Chart.js Line Chart - Legend"},annotation:{annotations:[{type:"line",mode:"vertical",scaleID:"x-axis-0",value:21,borderColor:"rgba(255, 255, 255, 1)",borderWidth:1,label:{content:"TODAY",enabled:!1,position:"left",backgroundColor:"rgba(255,255,255,1)",fontSize:9,xPadding:3,yPadding:3}}]},animation:{onComplete:function(){var t=this.chart,a=t.ctx;a.font=Chart.helpers.fontString(10,Chart.defaults.global.defaultFontStyle,Chart.defaults.global.defaultFontFamily),a.fillStyle="rgba(255, 255, 255, 1)",a.textAlign="center",a.textBaseline="bottom",a.fillText("NHIỆT ĐỘ PHÒNG",55,20),this.data.datasets.forEach(function(e,o){t.controller.getDatasetMeta(o).data.forEach(function(t,o){e.data.length-1==o&&(a.fillText("10:30",t._model.x+15,t._model.y+15),a.font=Chart.helpers.fontString(10,Chart.defaults.global.defaultFontStyle,Chart.defaults.global.defaultFontFamily),a.fillText(e.data[o]+"ºC",t._model.x+15,t._model.y))})})}}};t.chart=new Chart(a,{type:"line",options:l,data:{labels:["10:30","10:31","10:32",3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],datasets:[{label:"ºC",data:[25,15,13,16,18,20,21,15,13,16,18,20,21,15,13,16,18,20,21,25,16,18],borderColor:"rgba(255, 255, 255, 1)",pointBorderColor:"rgba(255, 255, 255, 1)",pointBackgroundColor:"rgba(255, 255, 255, 1)",pointHoverBackgroundColor:"rgba(255, 255, 255, 1)",pointHoverBorderColor:"rgba(255, 255, 255, 1)",pointBorderWidth:1,pointHoverBorderWidth:1,pointRadius:2,pointHoverRadius:2,fill:!0,borderWidth:1}]},lineAtIndex:[13]})}}),t}();
var config=function(){"use strict";return{debug:!0,api_id:{subscribe_events:1,get_states:2,identifier:10},passphrase:"7IeZlmfz123",weather_code:1117099,hass_server:"myhome.local",hass_port:"8123",const:{on:"on",off:"off",decrement:"decrement",increment:"increment"},entity_id:{switch:{front_light:"switch.front_light",main_light_power:"switch.main_light_power",main_light_sleep:"switch.main_light_sleep",main_light_brightness:"switch.main_light_brightness",amply_power:"switch.amply_power",toilet_light:"switch.toilet_light",toilet_fan:"switch.toilet_fan",barthroom_light:"switch.barthroom_light",aircon_power_off:"switch.aircon_power_off",aircon_mode_cool:"switch.aircon_mode_cool",aircon_mode_dry:"switch.aircon_mode_dry",aircon_mode_heat:"switch.aircon_mode_heat"},input_boolean:{system_sleep_mode:"input_boolean.system_sleep_mode",information_messages:"input_boolean.information_messages"},input_number:{main_light_brightness:"input_number.main_light_brightness"},sensor:{dht_sensor_temperature:"sensor.dht_sensor_temperature",dht_sensor_humidity:"sensor.dht_sensor_humidity"},device_tracker:{pc:"device_tracker.pc"}},aircon:{temp_max:32,temp_min:15},lang:{device_off_message:"Thiết bị đang tắt, hãy bật để điều chỉnh.",confirm_message:"Bạn có chắc chắn không ?"}}}();
!function(){"use strict";$(document).ready(function(){app.loadding(!0);var e=app.getParam("token");service.connectToService(),service.ws.onmessage=function(t){var n=$.parseJSON(t.data);if("auth_required"===n.type)return app.log("Auth required.."),void 0==e||""==e?void app.loginModal(!0):void service.ws.send(JSON.stringify({type:"auth",api_password:app.decryption(e)}));if("auth_invalid"===n.type)return app.log(n.message),void app.alert("Sai mật khẩu.").then(function(e){e&&setTimeout(function(){window.location.href="http://"+window.location.host},300)});if("auth_ok"===n.type){if(app.log("Auth ok. Ready to receive new state change.."),app.loginModal(!1),null==e){var i=app.encryption($("login-modal").find("input[name=txtPassword]").val());window.location.href=window.location.href+"?token="+i}return service.ws.send(JSON.stringify({id:config.api_id.subscribe_events,type:"subscribe_events",event_type:"state_changed"})),void service.getAllStates()}if("result"===n.type&&n.success&&null==n.result)config.api_id.identifier++;else if("result"===n.type&&n.success&&null!=n.result){var a=n.result;if($.isEmptyObject(a))return;$.each(a,function(e,t){service.updateAllState(t)})}else{if("event"===n.type&&n.id===config.api_id.subscribe_events)return service.updateAllState(n.event.data.new_state),void app.log(n.event.data.new_state);n.success}},service.ws.onclose=function(){app.loadding(!0,"Try reconnecting to HA.."),app.log("Socket closed"),setTimeout(function(){service.connectToService(),app.log("Try reconnect to HA service...")},5e3)},service.ws.onopen=function(){app.log("Connected to HA..."),app.loadding(!1,"Connected to HA...")},service.ws.onError=function(e){app.error(e.data),service.ws.close()},$("login-modal button[name=btnLogin]").click(function(e){var t=$("login-modal").find("input[name=txtPassword]"),n=t.val();return""!=n&&(service.ws.send(JSON.stringify({type:"auth",api_password:n})),t.val(n)),e.preventDefault()}),$("input.chk-input[type=checkbox]").click(function(e){var t=$(this).data("device"),n=app.getSwitchBtnState($(this));if(null!==t&&null!==n)return t===config.entity_id.input_boolean.system_sleep_mode&&n===config.const.on?(app.confirm(config.lang.confirm_message).then(function(e){e.value&&service.callHaService(t,n)}),e.preventDefault()):t==config.entity_id.device_tracker.pc&&n==config.const.off?(app.alert("Không thể tắt được máy tính."),e.preventDefault()):(setTimeout(function(){service.callHaService(config.entity_id.switch.aircon_power_off,config.const.off)},1e3),service.callHaService(t,n),e.preventDefault())});var t=$("aircon-modal");t.find(".airConditionerMode button").click(function(e){var t=$(this),n=t.find("span").text();return app.confirm(config.lang.confirm_message).then(function(e){e.value&&($(".airConditionerMode button").removeClass("active"),t.addClass("active"),app.alert("Đã chuyển sang chế độ <mark>"+n+"</mark>",null,null))}),e.preventDefault()});var n=t.find("input.airTemp");t.find(".btnAirTempDown").click(function(e){var t=n.val();return(t=parseInt(t))>config.aircon.temp_min&&(t-=1,n.val(t)),e.preventDefault()}),t.find(".btnAirTempUp").click(function(e){var t=n.val();return(t=parseInt(t))<config.aircon.temp_max&&(t+=1,n.val(t)),e.preventDefault()});var i=$("input.lightBrightness");$(".btnLightBrightness.Down").click(function(e){$(this).attr("disabled","disabled");var t=i.val();return t=t.replace("%",""),t=parseInt(t),(t=parseInt(t))>20&&(t-=20,i.val(t+"%")),service.callHaService(config.entity_id.switch.main_light_brightness,config.const.off),setTimeout(function(){$(".btnLightBrightness.Down").removeAttr("disabled"),service.callHaService(config.entity_id.input_number.main_light_brightness,config.const.decrement)},1e3),e.preventDefault()}),$(".btnLightBrightness.Up").click(function(e){$(this).attr("disabled","disabled");var t=i.val();return t=t.replace("%",""),t=parseInt(t),(t=parseInt(t))<100&&(t+=20,i.val(t+"%")),service.callHaService(config.entity_id.switch.main_light_brightness,config.const.on),setTimeout(function(){$(".btnLightBrightness.Up").removeAttr("disabled"),service.callHaService(config.entity_id.input_number.main_light_brightness,config.const.increment)},1e3),e.preventDefault()}),$("info-widget .item").click(function(e){var t=$(this).attr("data-entity"),n=$(this).attr("data-state");if(t===config.entity_id.input_boolean.system_sleep_mode&&n===config.const.off)return app.confirm(config.lang.confirm_message).then(function(e){e.value&&service.callHaService(t,config.const.on)}),e.preventDefault();n===config.const.on&&service.callHaService(t,config.const.off),n===config.const.off&&service.callHaService(t,config.const.on)})})}();
var service=function(){"use strict";return{ws:"",connectToService:function(){service.ws=new WebSocket("ws://"+config.hass_server+":"+config.hass_port+"/api/websocket")},callHaService:function(t,e){var i=t.split(".");if(2===i.length){var a=e;"switch"!==i[0]&&"input_boolean"!==i[0]||(a="turn_"+e),service.ws.send(JSON.stringify({id:config.api_id.identifier++,type:"call_service",domain:i[0],service:a,service_data:{entity_id:t}})),app.log("Called service: "+i[0]+"."+a+" "+t+" "+e)}},getAllStates:function(){this.ws.send(JSON.stringify({id:config.api_id.get_states,type:"get_states"})),app.log("Get all state....")},updateHtmlSwithByEntityId:function(t,e){app.setSwitchBtnState($(".chk-input[data-field=state][data-device='"+t+"']"),e)},updateAllState:function(t){if(!$.isEmptyObject(t)){var e=$("main-light-ctrl"),i=$("main-light-modal"),a=$("aircon-ctrl"),s=$("aircon-modal"),d=$("toilet-ctrl"),n=$("amply-ctrl"),o=$("bathroom-ctrl"),c=$("pc-ctrl"),l=$("sleepmode-ctrl"),r=$("sensor-detail-widget"),g=$("info-widget");switch(t.entity_id){case config.entity_id.sensor.dht_sensor_temperature:app.log("Updated state: "+t.entity_id+" "+t.state),r.find(".temperature .value").html(t.state+"ºC");break;case config.entity_id.sensor.dht_sensor_humidity:app.log("Updated state: "+t.entity_id+" "+t.state),r.find(".humidity .value").html(t.state+"%");break;case config.entity_id.device_tracker.pc:app.log("Updated state: "+t.entity_id+" "+t.state),service.updateHtmlSwithByEntityId(t.entity_id,"home"==t.state?config.const.on:config.const.off),c.find(".block").removeClass("disabled");break;case config.entity_id.input_boolean.system_sleep_mode:app.log("Updated state: "+t.entity_id+" "+t.state),service.updateHtmlSwithByEntityId(t.entity_id,t.state),l.find(".block").removeClass("disabled"),g.find('div.item[data-entity="'+config.entity_id.input_boolean.system_sleep_mode+'"]').attr("data-state",t.state);break;case config.entity_id.switch.front_light:app.log("Updated state: "+t.entity_id+" "+t.state),service.updateHtmlSwithByEntityId(t.entity_id,t.state);var f=$("front-light-ctrl");f.find(".block").removeClass("disabled"),t.state===config.const.on?f.find(".icon img").attr("src","assets/svg/lamp-on.svg"):f.find(".icon img").attr("src","assets/svg/lamp-off.svg");break;case config.entity_id.switch.main_light_power:app.log("Updated state: "+t.entity_id+" "+t.state),service.updateHtmlSwithByEntityId(t.entity_id,t.state),e.find(".block").attr("data-toggle","modal").removeClass("disabled"),t.state===config.const.on?(e.find(".row>.icon img").attr("src","assets/svg/chandelier-on.svg"),i.find(".grayPanel").hide()):(i.find(".grayPanel").show().find(".alert").html(config.lang.device_off_message),e.find(".row>.icon img").attr("src","assets/svg/chandelier-off.svg"));break;case config.entity_id.switch.main_light_sleep:if(app.log("Updated state: "+t.entity_id+" "+t.state),service.updateHtmlSwithByEntityId(t.entity_id,t.state),e.find(".block").attr("data-toggle","modal").removeClass("disabled"),t.state===config.const.on){e.find(".decBlock .icon").removeClass("hidden");break}e.find(".decBlock .icon").addClass("hidden");break;case config.entity_id.input_number.main_light_brightness:app.log("Updated state: "+t.entity_id+" "+t.state),function(t){var e=$(".lightBrightness");switch(parseInt(t)){case 1:e.val("20%");break;case 2:e.val("40%");break;case 3:e.val("60%");break;case 4:e.val("80%");break;case 5:e.val("100%")}}(t.state);break;case config.entity_id.switch.aircon_power_off:app.log("Updated state: "+t.entity_id+" "+t.state),service.updateHtmlSwithByEntityId(t.entity_id,t.state),a.find(".block").attr("data-toggle","modal").removeClass("disabled"),t.state===config.const.on?s.find(".grayPanel").hide():s.find(".grayPanel").show().find(".alert").html(config.lang.device_off_message);break;case config.entity_id.switch.aircon_mode_dry:case config.entity_id.switch.aircon_mode_cool:case config.entity_id.switch.aircon_mode_heat:app.log("Updated state: "+t.entity_id+" "+t.state);break;case config.entity_id.switch.amply_power:app.log("Updated state: "+t.entity_id+" "+t.state),service.updateHtmlSwithByEntityId(t.entity_id,t.state),n.find(".block").attr("data-toggle","modal").removeClass("disabled");break;case config.entity_id.switch.toilet_light:app.log("Updated state: "+t.entity_id+" "+t.state),d.find(".block").attr("data-toggle","modal").removeClass("disabled"),service.updateHtmlSwithByEntityId(t.entity_id,t.state),t.state===config.const.on?d.find(".icon.light").removeClass("hidden"):d.find(".icon.light").addClass("hidden");break;case config.entity_id.switch.toilet_fan:app.log("Updated state: "+t.entity_id+" "+t.state),d.find(".block").attr("data-toggle","modal").removeClass("disabled"),service.updateHtmlSwithByEntityId(t.entity_id,t.state),t.state===config.const.on?d.find(".icon.fan").removeClass("hidden"):d.find(".icon.fan").addClass("hidden");break;case config.entity_id.switch.barthroom_light:app.log("Updated state: "+t.entity_id+" "+t.state),o.find(".block").attr("data-toggle","modal").removeClass("disabled"),service.updateHtmlSwithByEntityId(t.entity_id,t.state)}}}}}();
!function(){"use strict";$(document).ready(function(){var s="select * from weather.forecast where (woeid = "+config.weather_code+") AND u='c'";$.ajax({dataType:"json",url:"https://query.yahooapis.com/v1/public/yql?q="+s+"&format=json"}).done(function(s){if(!$.isEmptyObject(s)){var a=s.query.results.channel,e=a.item.condition;e.class="wi-yahoo-"+e.code;var t=a.item.forecast;$("weather-widget>.row").html(""),$("weather-widget>.row").append('<div class="col col-sm-12 tday"><div class="row no-gutters"><div class="col-12 col-sm-4 text-center"><span class="text">'+a.location.city+'</span><i class="wi '+e.class+'"></i><span class="temp">'+e.temp+'º</span></div><div class="col-sm-8 d-none d-sm-block"><div class="row no-gutters"><div class="col-4 text-center"><i data-feather="sunrise" class=""></i><small>'+a.astronomy.sunrise+'</small></div><div class="col-4 text-center"><i data-feather="sunset" class=""></i><small>'+a.astronomy.sunset+'</small></div><div class="col-4 text-center"><i data-feather="droplet" class=""></i><small>'+a.atmosphere.humidity+"%</small></div></div></div></div></div>");for(var c=1;c<=6;c++){var o=Math.round((parseInt(t[c].high)+parseInt(t[c].low))/2);$("weather-widget>.row").append('<div class="col-1 col-sm wday"><span class="date">'+t[c].day+'</span><span class="icon"><i class="wi wi-yahoo-'+t[c].code+'"></i></span><span class="temp">'+o+"º</span></div>")}feather.replace()}}).fail(function(s){console.log(s.message)})})}();